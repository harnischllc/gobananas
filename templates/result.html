<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Ripeness Result - Go Bananas</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Go Bananas">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
                    <div>
                        <h1 class="display-6 fw-bold text-warning mb-0">üçå Ripeness Analysis</h1>
                        <p class="lead text-muted mb-0">Your banana classification results</p>
                    </div>
                    <div>
                        <a href="/" class="btn btn-warning">
                            <i class="fas fa-rotate-left me-2"></i>Analyze Another
                        </a>
                    </div>
                </div>

                {% if result and result.success %}
                    <!-- Main Result Card -->
                    <div class="card shadow-lg mb-4">
                        <div class="card-body p-4">
                            <!-- Stage Display -->
                            <div class="text-center mb-4">
                                <div class="stage-display">
                                    <div class="stage-number">{{ result.stage }}</div>
                                    <div class="stage-name">{{ result.stage_info.split(' - ')[0] if result.stage_info else 'Unknown Stage' }}</div>
                                </div>
                            </div>

                            <!-- Stage Description -->
                            <div class="alert alert-info mb-4">
                                <h5><i class="fas fa-info-circle me-2"></i>Stage Description</h5>
                                <p class="mb-0">{{ result.stage_info if result.stage_info else result.description }}</p>
                            </div>

                            <!-- Days Until Peak -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="info-card">
                                        <div class="info-icon">
                                            <i class="fas fa-clock fa-2x text-warning"></i>
                                        </div>
                                        <div class="info-content">
                                            <h6>Peak Ripeness</h6>
                                            {% if result.stage >= 6 %}
                                                <p class="mb-0 text-success"><strong>Already at peak ripeness!</strong></p>
                                            {% else %}
                                                <p class="mb-0"><strong>Approximately {{ result.days_until_peak }} days</strong> until peak eating quality</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Color Swatch - Commented out as per requirements -->
                            <!--
                            <div class="text-center mb-4">
                                <h5><i class="fas fa-eye me-2"></i>Detected Color</h5>
                                <div class="detected-color-swatch">
                                    <div class="swatch-circle" id="detectedColorSwatch"></div>
                                    <div class="swatch-info">
                                        <strong>Hue: {{ "%.1f"|format(result.hue) }}¬∞</strong><br>
                                        <span class="text-muted">Dominant color detected</span>
                                    </div>
                                </div>
                            </div>
                            -->

                            <!-- Recommendations -->
                            {% if result.recommendations %}
                                <div class="alert alert-light">
                                    <h5><i class="fas fa-lightbulb me-2"></i>Recommendations</h5>
                                    <ul class="mb-0">
                                        {% for rec in result.recommendations %}
                                            <li>{{ rec }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}

                            <!-- Confidence Score -->
                            {% if result.confidence is defined %}
                                <div class="text-center mb-4">
                                    <div class="confidence-display">
                                        <h6>Analysis Confidence</h6>
                                        <div class="mb-2">
                                            {% set conf_pct = (result.confidence * 100) | float %}
                                            {% if conf_pct > 80 %}
                                                <span class="badge bg-success fs-6">üü¢ Highly Confident ({{ "%.0f"|format(conf_pct) }}%)</span>
                                            {% elif conf_pct > 60 %}
                                                <span class="badge bg-warning text-dark fs-6">üü° Moderately Confident ({{ "%.0f"|format(conf_pct) }}%)</span>
                                            {% else %}
                                                <span class="badge bg-danger fs-6">üî¥ Low Confidence ({{ "%.0f"|format(conf_pct) }}%) - Try better lighting</span>
                                            {% endif %}
                                        </div>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if result.confidence > 0.8 %}bg-success{% elif result.confidence > 0.6 %}bg-warning{% else %}bg-danger{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ result.confidence * 100 }}%">
                                                {{ "%.1f"|format(result.confidence * 100) }}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Additional Info Section -->
                    <div class="card shadow-lg mb-4">
                        <div class="card-body p-4">
                            <h5 class="card-title"><i class="fas fa-seedling me-2"></i>Banana Care Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <h6><i class="fas fa-thermometer-half text-info me-2"></i>Shelf Life</h6>
                                        <p class="mb-0">Ripe bananas stay fresh <strong>3-7 days at 56-65¬∞F</strong></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <h6><i class="fas fa-home text-warning me-2"></i>Storage Tips</h6>
                                        <p class="mb-0"><strong>Warmer = faster ripening, cooler = slower</strong></p>
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="tip-item text-center">
                                        <i class="fas fa-snowflake fa-2x text-primary mb-2"></i>
                                        <h6>To Slow Ripening</h6>
                                        <p class="small text-muted">Store in refrigerator (peel will darken but fruit stays good)</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="tip-item text-center">
                                        <i class="fas fa-fire fa-2x text-warning mb-2"></i>
                                        <h6>To Speed Ripening</h6>
                                        <p class="small text-muted">Place in paper bag with apple or banana</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="tip-item text-center">
                                        <i class="fas fa-ice-cream fa-2x text-success mb-2"></i>
                                        <h6>Freeze Overripe</h6>
                                        <p class="small text-muted">Perfect for smoothies, banana bread, and baking</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% elif result and result.error %}
                    <!-- Error Display -->
                    <div class="card shadow-lg mb-4">
                        <div class="card-body p-4 text-center">
                            <div class="error-display">
                                <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
                                <h4>Analysis Failed</h4>
                                <p class="text-muted">{{ result.error }}</p>
                                <p class="small">Please try again with a clearer image or different color selection.</p>
                            </div>
                        </div>
                    </div>

                {% else %}
                    <!-- Fallback Error -->
                    <div class="card shadow-lg mb-4">
                        <div class="card-body p-4 text-center">
                            <div class="error-display">
                                <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
                                <h4>Analysis Failed</h4>
                                <p class="text-muted">Sorry, we couldn't analyze your banana image. Please try again with a clearer photo.</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Quick Color Guide -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üåà Banana Color Guide</h5>
                        <div class="row text-center">
                            <div class="col-md-3 col-6 mb-3">
                                <div class="color-guide-item">
                                    <div class="color-circle" style="background-color: #228B22; cursor: pointer;"></div>
                                    <small>Stage 1-2<br>Green</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="color-guide-item">
                                    <div class="color-circle" style="background-color: #9ACD32; cursor: pointer;"></div>
                                    <small>Stage 3-4<br>Light Green</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="color-guide-item">
                                    <div class="color-circle" style="background-color: #FFD700; cursor: pointer;"></div>
                                    <small>Stage 5-6<br>Yellow</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="color-guide-item">
                                    <div class="color-circle" style="background-color: #D2691E; cursor: pointer;"></div>
                                    <small>Stage 7<br>Brown</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Analyses (optional - remove if not needed) -->
                <div class="card mt-4" id="recentCard" style="display:none;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">üïí Recent Analyses</h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearHistoryBtn">Clear</button>
                        </div>
                        <div id="recentList" class="recent-list row g-3">
                            <!-- Rendered by JS -->
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mb-5">
                    <a href="/" class="btn btn-warning btn-lg me-3">
                        <i class="fas fa-banana me-2"></i>Analyze Another Banana
                    </a>
                    <a href="/about" class="btn btn-outline-secondary">
                        <i class="fas fa-info-circle me-2"></i>Learn More
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Set the detected color swatch
        document.addEventListener('DOMContentLoaded', function() {
            {% if result and result.hue %}
            const hue = {{ result.hue }};
            const detectedSwatch = document.getElementById('detectedColorSwatch');
            if (detectedSwatch) {
                // Convert hue to HSL color for display
                const color = `hsl(${hue}, 70%, 50%)`;
                detectedSwatch.style.backgroundColor = color;
            }
            {% endif %}

            // Save recent analysis to localStorage
            try {
                {% if result %}
                const historyKey = 'gobananas_history';
                const entry = {
                    stage: {{ result.stage if result.stage is defined else 0 }},
                    hue: {{ result.hue if result.hue is defined else 60 }},
                    timestamp: Date.now(),
                    stageInfo: {{ result.stage_info | tojson if result.stage_info else 'null' }}
                };
                const existing = JSON.parse(localStorage.getItem(historyKey) || '[]');
                existing.unshift(entry);
                const pruned = existing.slice(0, 10);
                localStorage.setItem(historyKey, JSON.stringify(pruned));
                {% endif %}
                
                // Display recent analyses
                displayRecentAnalyses();
                
                // Setup clear history button
                const clearHistoryBtn = document.getElementById('clearHistoryBtn');
                if (clearHistoryBtn) {
                    clearHistoryBtn.addEventListener('click', clearHistory);
                }
            } catch (e) {
                console.warn('Unable to save recent analysis', e);
            }
            
            function displayRecentAnalyses() {
                const recentCard = document.getElementById('recentCard');
                const recentList = document.getElementById('recentList');
                const historyKey = 'gobananas_history';
                
                try {
                    const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                    
                    if (history.length === 0) {
                        recentCard.style.display = 'none';
                        return;
                    }
                    
                    recentCard.style.display = 'block';
                    recentList.innerHTML = '';
                    
                    history.forEach((entry, index) => {
                        if (index === 0) return; // Skip current analysis
                        
                        const stageData = {
                            1: { color: '#228B22', name: 'Stage 1: Green' },
                            2: { color: '#32CD32', name: 'Stage 2: Light Green' },
                            3: { color: '#9ACD32', name: 'Stage 3: Yellowish' },
                            4: { color: '#ADFF2F', name: 'Stage 4: Light Yellow' },
                            5: { color: '#FFD700', name: 'Stage 5: Golden' },
                            6: { color: '#FFA500', name: 'Stage 6: Overripe' },
                            7: { color: '#D2691E', name: 'Stage 7: Brown' }
                        };
                        
                        const data = stageData[entry.stage] || { color: '#FFD700', name: 'Unknown Stage' };
                        const timeAgo = getTimeAgo(entry.timestamp);
                        
                        const recentItem = document.createElement('div');
                        recentItem.className = 'col-md-4 col-sm-6 mb-3';
                        recentItem.innerHTML = `
                            <div class="recent-item p-3">
                                <div class="d-flex align-items-center">
                                    <div class="recent-color me-3" style="background-color: ${data.color};"></div>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">${data.name}</div>
                                        <small class="text-muted">${timeAgo}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        recentList.appendChild(recentItem);
                    });
                } catch (e) {
                    console.warn('Error displaying recent analyses:', e);
                    recentCard.style.display = 'none';
                }
            }
            
            function clearHistory() {
                if (confirm('Are you sure you want to clear your analysis history?')) {
                    localStorage.removeItem('gobananas_history');
                    displayRecentAnalyses();
                }
            }
            
            function getTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }
        });
    </script>

    <style>
        .stage-display {
            margin: 2rem 0;
        }

        .stage-number {
            font-size: 4rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        .stage-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-card {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            height: 100%;
            color: #333 !important;
        }

        .info-icon {
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .info-content h6 {
            margin-bottom: 0.5rem;
            color: #495057 !important;
        }

        .info-card p {
            color: #333 !important;
        }

        .info-content {
            color: #333 !important;
        }

        .detected-color-swatch {
            display: inline-flex;
            align-items: center;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #dee2e6;
        }

        .swatch-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 1.5rem;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .confidence-display {
            max-width: 300px;
            margin: 0 auto;
        }

        .info-item {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info-item h6 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .tip-item {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .tip-item h6 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .error-display {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .stage-number {
                font-size: 3rem;
            }
            
            .stage-name {
                font-size: 1.2rem;
            }
            
            .info-card {
                flex-direction: column;
                text-align: center;
            }
            
            .info-icon {
                margin-right: 0;
                margin-bottom: 1rem;
            }
            
            .detected-color-swatch {
                flex-direction: column;
                text-align: center;
            }
            
            .swatch-circle {
                margin-right: 0;
                margin-bottom: 1rem;
            }
        }
    </style>
</body>
</html>
